<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ex.mater.mater.MaterMapper">

	<resultMap id="fileCommand" type="com.ex.mater.mater.FileCommand">
		<result column="MNPB_ASK_YYMM" property="mnpbAskYYMM"/>
		<result column="MTRI_CUST_NO" property="mtriCustNo"/>
		<result column="MNPB_ASK_SQNO" property="mnpbAskSqno"/>
		<result column="MNPB_CLSS_CD" property="mnpbClssCd"/>
		<result column="FILD_CLSS_CD" property="fildClssCd"/>
		<result column="CNTC_WKSC_CD" property="cntcWkscCd"/>
		<result column="CNTRT_CRPR_NM" property="cntrtCrprNm"/>
		<result column="CNTRT_CRPR_CD" property="cntrtCrprCd"/>
		<result column="CNTRT_CNTC_NO" property="cntrtCntcNo"/>
		<result column="CNTRT_NM" property="cntrtNm"/>
		<result column="CNTRT_CD" property="cntrtCd"/>
		<result column="DLGD_AMNT" property="dlgdAmnt"/>
		<result column="DLGD_UNPR" property="dlgdUnpr"/>
		<result column="ASK_AMT" property="askAmt"/>
		<result column="ATTFL_SEQ" property="attflSeq"/>
		<result column="MNPB_STAT_CD" property="mnpbStatCd"/>
		<result column="PPS_TRNM_YN" property="ppsTrnmYn"/>
		<result column="FSTTM_RGSR_ID" property="fsttmRgsrId"/>
		<result column="LSTTM_MODFR_ID" property="lsttmModfrId"/>
		<result column="ETC_RMRK" property="etcRmrk"/>
		<result column="CORP_NM" property="corpNm"/>
		<result column="CUST_TELNO" property="custTelno"/>
		<result column="RPPR_NM" property="rpprNm"/>
		<result column="DEPR_NM" property="deprNm"/>
		<result column="TR_BANK_NM" property="trBankNm"/>
		<result column="BANK_ACTNO" property="bankActno"/>
		<result column="ATTFL_NM" property="attflNm"/>
		<result column="ATTFL_PATH" property="attflPath"/>
		<result column="CUST_NM" property="custNm"/>
		<result column="TOTAL" property="total"/>
		<result column="MNPB_RGSR_SEQ" property="mnpbRgsrSeq"/>
	</resultMap>
	
    <insert id="insertMaterList" parameterType="com.ex.mater.mater.FileCommand">
    	INSERT INTO T_MTRI_MNPB_01M1
    	(
	    	  MNPB_ASK_YYMM
			, MTRI_CUST_NO
			, MNPB_ASK_SQNO
			, MNPB_CLSS_CD
			, FILD_CLSS_CD
			, CNTC_WKSC_CD
			, CNTRT_CRPR_NM
			, CNTRT_CRPR_CD
			, CNTRT_CNTC_NO
			, CNTRT_NM
			, CNTRT_CD
			, DLGD_AMNT
			, DLGD_UNPR
			, ASK_AMT
			, ATTFL_SEQ
			, MNPB_STAT_CD
			, PPS_TRNM_YN
			, FSTTM_RGSR_ID
			, FSTTM_RGST_DTTM
			, LSTTM_MODFR_ID
			, LSTTM_ALTR_DTTM
			, ETC_RMRK
			, MNPB_RGSR_SEQ
    	) VALUES (
 	    	  #{mnpbAskYYMM}
			, #{mtriCustNo}
			, (SELECT NVL(MAX(MNPB_ASK_SQNO)+1, 1) FROM T_MTRI_MNPB_01M1 WHERE MNPB_ASK_YYMM = #{mnpbAskYYMM} AND MTRI_CUST_NO = #{mtriCustNo} AND MNPB_CLSS_CD = #{mnpbClssCd})
			, #{mnpbClssCd}
			, #{fildClssCd}
			, #{cntcWkscCd}
			, #{cntrtCrprNm}
			, #{cntrtCrprCd}
			, #{cntrtCntcNo}
			, #{cntrtNm}
			, #{cntrtCd}
			, #{dlgdAmnt}
			, #{dlgdUnpr}
			, #{askAmt}
			, #{attflSeq}
			, '01'
			, NVL(#{ppsTrnmYn}, 'N')
			, #{mtriCustNo}
			, SYSDATE
			, #{mtriCustNo}
			, SYSDATE
			, #{etcRmrk}
			, #{mnpbRgsrSeq}
    	)
    </insert>
    
    <insert id="insertMaterAttfl" parameterType="com.ex.mater.mater.FileCommand">
    	<selectKey resultType="String" keyProperty="attflSeq" order="BEFORE">
			SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(ATTFL_SEQ, 9,6)))+1, 1),4, '0') as attflSeq 
			 FROM T_MTRI_ATTFL 
			  WHERE ATTFL_SEQ LIKE TO_CHAR(SYSDATE, 'YYYYMMDD')||'%'
		</selectKey>
    	INSERT INTO T_MTRI_ATTFL (
    		  ATTFL_SEQ
    		, ATTFL_SQNO
    		, ATTFL_NM
    		, ATTFL_PATH
    	) VALUES(
    		  #{attflSeq}
    		, (SELECT NVL(MAX(ATTFL_SQNO)+1, 1) FROM T_MTRI_ATTFL WHERE ATTFL_SEQ = #{attflSeq})
    		, #{attflNm}
    		, #{attflPath}
    	)
    </insert>
    
    <select id="selectMaterList" parameterType="map" resultMap="fileCommand">
    	SELECT A.FILD_CLSS_CD       -- 현장구분코드
		     , A.CNTC_WKSC_CD       -- 건설공구코드
		     , A.CNTRT_CRPR_NM      -- 계약업체명
		     , B.DEPR_NM            -- 예금주
		     , A.CNTRT_CD           -- 대금코드
		     , A.CNTRT_NM			-- 대금명
		     , A.MNPB_ASK_YYMM      -- 대금청구년월
		     , A.MNPB_ASK_SQNO      -- 대금청구순번
             , A.MNPB_CLSS_CD       -- 대금구분코드
		     , B.CORP_NM            -- 대금업체명
		     , A.MNPB_RGSR_SEQ      -- 대금등록일련번호
		     , TO_CHAR( NVL(A.ASK_AMT, 0), '999,999,999,999,999') AS ASK_AMT -- 청구액
		 FROM T_MTRI_MNPB_01M1 A
		    LEFT OUTER JOIN T_MTRI_CUST01M1 B
		    ON A.MTRI_CUST_NO = B.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_CUST01D1 C
		    ON B.MTRI_CUST_NO = C.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_ATTFL D
		    ON A.ATTFL_SEQ = D.ATTFL_SEQ
		 WHERE 1 = 1
		 AND A.MTRI_CUST_NO = #{mtriCustNo}
		 AND A.MNPB_ASK_YYMM BETWEEN #{sMonth} AND #{eMonth}
		 ORDER BY MNPB_ASK_YYMM DESC
    </select>
    
    <select id="selectMainList" parameterType="map" resultMap="fileCommand">
    SELECT *
     FROM (	
    	SELECT A.FILD_CLSS_CD       -- 현장구분코드
		     , A.CNTC_WKSC_CD       -- 건설공구코드
		     , A.CNTRT_CRPR_NM      -- 계약업체명
		     , B.DEPR_NM            -- 예금주
		     , A.CNTRT_CD           -- 대금코드
		     , A.CNTRT_NM			-- 대금명
		     , SUBSTR(A.MNPB_ASK_YYMM, 0, 4) || '.' || SUBSTR(A.MNPB_ASK_YYMM, 5,6) AS MNPB_ASK_YYMM
		     , A.MNPB_ASK_SQNO -- 대금청구순번
		     , TO_CHAR( NVL(A.ASK_AMT, 0), '999,999,999,999,999') AS ASK_AMT -- 청구액
		     , B.CUST_NM			-- 회사명
             , B.CORP_NM            -- 대금업체명
             , COUNT(*) OVER (PARTITION BY 1) AS TOTAL	-- TOTAL 개수
             , A.MNPB_CLSS_CD       -- 대금구분코드
		 FROM T_MTRI_MNPB_01M1 A
		    LEFT OUTER JOIN T_MTRI_CUST01M1 B
		    ON A.MTRI_CUST_NO = B.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_CUST01D1 C
		    ON B.MTRI_CUST_NO = C.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_ATTFL D
		    ON A.ATTFL_SEQ = D.ATTFL_SEQ
		 WHERE 1 = 1
		 AND A.MTRI_CUST_NO = #{mtriCustNo}
		 ORDER BY MNPB_ASK_YYMM DESC
		 )
	WHERE ROWNUM <![CDATA[ < ]]> 4
    </select>
    
    <select id="selectMaterDetail" parameterType="map" resultMap="fileCommand">
    	SELECT A.FILD_CLSS_CD       -- 현장구분코드
		     , A.CNTC_WKSC_CD   -- 건설공구코드
		     , A.CNTRT_CRPR_NM  -- 계약업체명
		     , B.DEPR_NM        -- 예금주
		     , A.CNTRT_CD       -- 대금코드
		     , A.CNTRT_NM	    -- 대금명
		     , A.MNPB_ASK_YYMM  -- 자재대금청구년월
		     , A.MNPB_ASK_SQNO  -- 자재대금청구순번
		     , TO_CHAR( NVL(A.ASK_AMT, 0), '999,999,999,999,999') AS ASK_AMT -- 청구액
             , B.CORP_NM        -- 자재업체명
             , REGEXP_REPLACE(B.CUST_TELNO, '(.{3})(.*)(.{4})', '\1-\2-\3') CUST_TELNO
             , A.MTRI_CUST_NO   -- 사업자번호
             , RPPR_NM          -- 대표자명
             , TR_BANK_NM       -- 은행명
             , BANK_ACTNO       -- 계좌번호
             , ASK_AMT          -- 청구금액
             , ATTFL_NM         -- 파일명
             , ATTFL_PATH       -- 파일경로
             , A.MNPB_CLSS_CD	-- 대금구분코드
             , A.MNPB_RGSR_SEQ  -- 대금등록일련번호
             , A.MNPB_STAT_CD   -- 대금상태코드
             , A.ATTFL_SEQ		-- 첨부파일일련번호
		 FROM T_MTRI_MNPB_01M1 A
		    LEFT OUTER JOIN T_MTRI_CUST01M1 B
		    ON A.MTRI_CUST_NO = B.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_CUST01D1 C
		    ON B.MTRI_CUST_NO = C.MTRI_CUST_NO
		    LEFT OUTER JOIN T_MTRI_ATTFL D
		    ON A.ATTFL_SEQ = D.ATTFL_SEQ
		 WHERE 1 = 1
		 AND A.MNPB_ASK_YYMM = #{mnpbAskYYMM}
         AND A.MTRI_CUST_NO = #{mtriCustNo}
         AND A.MNPB_CLSS_CD = #{mnpbClssCd}
         AND A.MNPB_ASK_SQNO = #{mnpbAskSqno}
    </select>
    
    
    <update id="updateMaterList" parameterType="com.ex.mater.mater.FileCommand">
    	UPDATE T_MTRI_MNPB_01M1
    	  SET FILD_CLSS_CD = #{fildClssCd}
			, CNTC_WKSC_CD = #{cntcWkscCd}
			, CNTRT_CRPR_NM = #{cntrtCrprNm}
			, CNTRT_CRPR_CD = #{cntrtCrprCd}
			, CNTRT_CNTC_NO = #{cntrtCntcNo}
			, CNTRT_NM = #{cntrtNm}
			, CNTRT_CD = #{cntrtCd}
			, DLGD_AMNT = #{dlgdAmnt}
			, DLGD_UNPR = #{dlgdUnpr}
			, ASK_AMT = #{askAmt}
			, ATTFL_SEQ = #{attflSeq}
			, LSTTM_MODFR_ID = #{mtriCustNo}
			, LSTTM_ALTR_DTTM = SYSDATE
			, ETC_RMRK = #{etcRmrk}
			, MNPB_RGSR_SEQ = #{mnpbRgsrSeq}
		  WHERE MTRI_CUST_NO = #{mtriCustNo}
		  AND MNPB_ASK_SQNO = #{mnpbAskSqno}
		  AND MNPB_CLSS_CD = #{mnpbClssCd}
		  AND MNPB_ASK_YYMM = #{mnpbAskYYMM}
    </update>
    
    <update id="updateMaterAttfl" parameterType="com.ex.mater.mater.FileCommand">
    	UPDATE T_MTRI_ATTFL 
    	SET ATTFL_NM = #{attflNm} 
    	  , ATTFL_PATH = #{attflPath}
    	WHERE ATTFL_SEQ = #{attflSeq}
    	AND ATTFL_NM = #{etcFileName}
    </update>
    
    <delete id="deleteMater" parameterType="map">
    	DELETE FROM T_MTRI_MNPB_01M1
    	 WHERE MTRI_CUST_NO = #{mtriCustNo}
		 AND MNPB_ASK_SQNO = #{mnpbAskSqno}
		 AND MNPB_CLSS_CD = #{mnpbClssCd} 
		 AND MNPB_ASK_YYMM = #{mnpbAskYYMM}
    </delete>
</mapper>
